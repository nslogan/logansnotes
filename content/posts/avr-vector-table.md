Title: AVR Vector Table
Date: 2020-04-19 4:00 PM
Category: test

TODO:

- [ ] Add what the motivation behind this post is
- [ ] Flush out content with more explanation, put places for future links to topics (e.g. gcc, ELF, etc.)

---

<!-- NOTE: This should probably be in a 'flash' message or quote or something to call it out -->
TL;DR: `avr-libc/crt1/gcrt1.S`

I came across the concept of "relocations" while reviewing objects generated by my research. Relocatable sections are an ELF thing (well, the concept is in a lot of object file formats, but I care about ELF in this case). Support for specific types of relocations are found in these source files:

- `~/src/gcc-dev/binutils-2.32/include/elf/avr.h`
- `~/src/gcc-dev/binutils-2.32/bfd/elf-avr.h`

For example, the relocation `R_AVR_LDI` has number 19 (which is what is stored in the ELF field) is implemented in `elf32-avr.c` in the parts of the file where you can fine `R_AVR_LDI` (I don't know exactly how this works yet).

The actual vector table is defined in `avr-libc-1.8.1/crt1/gcrt1.S`. The section `.vectors` is created and a global label `__vectors` is defined in it. Each entry that follows uses the `vector` macro defined in this file:


```gas
.macro	vector name
.if (. - __vectors < _VECTORS_SIZE)
.weak	\name
.set	\name, __bad_interrupt
XJMP	\name
.endif
.endm
```

<!-- NOTE: I need to add support for mako tags into my pipeline so that I can add functions to generate flash boxes, add octicons, etc. Right now I'm just going to use this ugly HTML chunk below. One side-effect of this is I can't use markdown *inside* this block. Damn. -->
<div class="flash mb-3" markdown="1"><i class="far fa-thumbs-down mr-2"></i>The Pygments `lexers.asm.GasLexer` doesn't support the macro family of syntax so the backslash above is marked as invalid. I may consider submitting a patch for better gas support in the [lexer](https://bitbucket.org/birkenfeld/pygments-main/src/default/pygments/lexers/asm.py) if I get around to it.
</div>

And is used like this:

```gas
	.section .vectors,"ax",@progbits
	.global	__vectors
	.func	__vectors
__vectors:
	XJMP	__init
	vector	__vector_1
	# ...
```

Which does some important stuff:

- Only define entries for vectors that are supported by the target architecture. This is done by subtracting the current address from the `__vectors` label address and making sure it less than `_VECTORS_SIZE` which is defined in the header for the part(s) that the library is being compiled for (e.g. `avr/iomxx0_1.h`). It's important to note that a library is generated for every avr-libc supported part, e.g. `<build>/avr/lib/avr6/atmega2560/libcrt.a`, which is how this vector table with variable number of entires works.
- Set the vector name (e.g. `__vector_1`) to be a `weak` symbol which means that a non-`weak` symbol declared in another object file would override the definition from this file. This allows the library to contain a default implementation of the function that can be replaced by a user function defined outside of the library
- Assign a default interrupt handler, `__bad_interrupt`, to the vector name that will handle unexpected interrupts (e.g. interrupts enabled by accident or interrupts intentionally enabled but that a handler was not implemented for by accident)
- Emit the assembly instruction `XJMP` to jump to the interrupt handler
